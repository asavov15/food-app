{% extends "layout.html" %}

{% block content %}
<h2>All Food Spots</h2>

<form method="GET" action="/spots">
  <label>Search (name or category):</label>
  <input
    type="text"
    name="q"
    value="{{ request.args.get('q', '') }}"
  >

  <label>Min rating:</label>
  <input
    type="number"
    name="min_rating"
    min="1"
    max="5"
    step="0.1"
    value="{{ request.args.get('min_rating', '') }}"
  >

  <fieldset>
    <legend>Filter by tags:</legend>

    <label>
      <input
        type="checkbox"
        name="late_night"
        value="1"
        {% if request.args.get('late_night') %}checked{% endif %}
      >
      Late Night
    </label>

    <label>
      <input
        type="checkbox"
        name="fine_dining"
        value="1"
        {% if request.args.get('fine_dining') %}checked{% endif %}
      >
      Fine Dining
    </label>

    <label>
      <input
        type="checkbox"
        name="health_conscious"
        value="1"
        {% if request.args.get('health_conscious') %}checked{% endif %}
      >
      Health Conscious
    </label>

    <label>
      <input
        type="checkbox"
        name="affordable"
        value="1"
        {% if request.args.get('affordable') %}checked{% endif %}
      >
      Affordable
    </label>

    <label>
      <input
        type="checkbox"
        name="sweet_treat"
        value="1"
        {% if request.args.get('sweet_treat') %}checked{% endif %}
      >
      Sweet Treat
    </label>

    <label>
      <input
        type="checkbox"
        name="close"
        value="1"
        {% if request.args.get('close') %}checked{% endif %}
      >
      Close to Harvard Yard
    </label>
  </fieldset>

  <button type="submit">Apply</button>
  <a href="/spots">Clear</a>
</form>


<!-- Map container -->
<div id="spots-map" data-spots='{{ spot_data | tojson | safe }}'></div>

{% if spots %}
  <ul>
    {% for spot in spots %}
      <li>
        <a href="/spot/{{ spot['id'] }}">{{ spot["name"] }}</a>
        {% if spot["category"] %} ({{ spot["category"] }}) {% endif %}

        {% if spot["avg_rating"] is not none %}
         – {{ spot["avg_rating"] }}★
          ({{ spot["review_count"] }} review{% if spot["review_count"] != 1 %}s{% endif %})
        {% else %}
          – No reviews yet
        {% endif %}

        <!-- TAGS -->
        <div class="tags">
          {% if spot.late_night %}<span class="tag">Late Night</span>{% endif %}
          {% if spot.fine_dining %}<span class="tag">Fine Dining</span>{% endif %}
          {% if spot.health_conscious %}<span class="tag">Health Conscious</span>{% endif %}
          {% if spot.affordable %}<span class="tag">Affordable</span>{% endif %}
          {% if spot.sweet_treat %}<span class="tag">Sweet Treat</span>{% endif %}
          {% if spot.close %}<span class="tag">Close to Harvard Yard</span>{% endif %}
        </div>
      </li>
    {% endfor %}

  </ul>
{% else %}
  <p>No spots match your search.</p>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
  const mapDiv = document.getElementById("spots-map");

  if (mapDiv) {
    const map = L.map("spots-map").setView([42.3736, -71.1097], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Read JSON from the data attribute
    const spotsJson = mapDiv.dataset.spots;
    let spots = [];

    try {
      spots = JSON.parse(spotsJson);
    } catch (e) {
      console.error("Failed to parse spot data", e);
    }

    // Add markers
    spots.forEach(function (s) {
      if (s.latitude && s.longitude) {
        const marker = L.marker([s.latitude, s.longitude]).addTo(map);

        let popup = "<strong>" + s.name + "</strong>";

        if (s.category) {
          popup += "<br>" + s.category;
        }

        if (s.avg_rating !== null) {
          popup += "<br>" + s.avg_rating + "★ (" + s.review_count + " reviews)";
        }

        // Add link to the spot detail / reviews page
        popup += '<br><a href="/spot/' + s.id + '">View details &amp; reviews</a>';

        marker.bindPopup(popup);
      }
    });

  }
</script>
{% endblock %}



